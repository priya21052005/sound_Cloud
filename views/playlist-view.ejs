<div class="playlist-header">
  <h1 class="playlist-title">üéµ <%= playlist.name %></h1>
  <p class="playlist-info"><%= playlist.songs ? playlist.songs.length : 0 %> songs in your playlist</p>
  <div class="playlist-actions">
    <a href="/playlists" class="back-link">‚¨Ö Back to Playlists</a>
    <form action="/playlists/<%= playlist._id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Delete this playlist? This action cannot be undone.');">
      <button type="submit" class="delete-playlist-btn">üóëÔ∏è Delete Playlist</button>
    </form>
  </div>
</div>

<% if (playlist.songs && playlist.songs.length > 0) { %>
  <% const song = playlist.songs[0]; const songs = playlist.songs; %>

  <div class="player-wrap">
    <div class="player-left">
      <img src="<%= song.thumbnail || song.cover || '/images/default-cover.png' %>" alt="cover" class="player-cover">
      <div class="now-info">
        <div class="now-title"><%= song.title %></div>
        <div class="now-artist"><%= song.artist %></div>
      </div>
    </div>

    <div class="player-center">
      <div class="controls">
        <div class="control-btn prev" title="Previous">‚èÆ</div>
        <div class="control-btn play" id="playBtn">‚ñ∂</div>
        <div class="control-btn next" title="Next">‚è≠</div>
      </div>

      <div class="progress">
        <div class="time" id="currentTime">0:00</div>
        <div class="progress-bar" id="progressBar">
          <div class="fill" id="progressFill"></div>
        </div>
        <div class="time" id="duration">0:00</div>
      </div>

      <div style="margin-top:14px; text-align:center; color:var(--muted)">Use the controls above or the system audio controls below.</div>

      <div style="margin-top:12px">
        <audio id="audioPlayer" src="<%= song.file %>" preload="metadata"></audio>
      </div>
    </div>

    <div class="player-right">
      <div class="queue-panel">
        <h3 style="margin:0 0 10px 0">Queue</h3>
        <% songs.forEach((s, idx) => { %>
          <div class="queue-item <%= idx===0 ? 'active' : '' %>" data-idx="<%= idx %>" data-src="<%= s.file %>">
            <img src="<%= s.thumbnail || s.cover || '/images/default-cover.png' %>" alt="thumb">
            <div class="meta">
              <div class="q-title"><%= s.title %></div>
              <div class="q-artist"><%= s.artist %></div>
            </div>
            <div class="q-action">‚ñ∂</div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <section class="playlist-add-section">
    <h3 class="section-heading">‚ûï Add More Songs</h3>
    <% if (songs && songs.length > 0) { %>
      <div class="add-songs-grid">
        <% songs.forEach(song => { 
             const alreadyAdded = playlist.songs.find(s => s._id.toString() === song._id.toString());
             if(!alreadyAdded){ %>
          <div class="add-song-card">
            <div class="add-song-image">
              <% if (song.thumbnail) { %>
                <img src="<%= song.thumbnail %>" alt="<%= song.title %>">
              <% } else { %>
                <img src="/images/default-cover.png" alt="default">
              <% } %>
            </div>
            <div class="add-song-info">
              <h4 class="add-song-title"><%= song.title %></h4>
              <p class="add-song-artist"><%= song.artist %></p>
              <form action="/playlists/<%= playlist._id %>/add/<%= song._id %>" method="POST" class="add-song-form">
                <button type="submit" class="add-song-btn">+ Add</button>
              </form>
            </div>
          </div>
        <% } %>
        <% }) %>
      </div>
    <% } else { %>
      <p class="no-songs-msg">No additional songs available</p>
    <% } %>
  </section>

  <script>
    const audio = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playBtn');
    const progressFill = document.getElementById('progressFill');
    const currentTime = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');

    function fmt(s){ if(!isFinite(s)) return '0:00'; const m=Math.floor(s/60); const sec=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }

    audio.addEventListener('loadedmetadata', ()=>{ durationEl.textContent = fmt(audio.duration); });
    audio.addEventListener('timeupdate', ()=>{ const pct=(audio.currentTime/audio.duration)*100||0; progressFill.style.width=pct+'%'; currentTime.textContent=fmt(audio.currentTime); });

    playBtn.addEventListener('click', ()=>{ if(audio.paused){ audio.play(); playBtn.textContent='‚è∏'; } else { audio.pause(); playBtn.textContent='‚ñ∂'; } });

    // Queue click
    document.querySelectorAll('.queue-item').forEach(item=>{
      item.addEventListener('click', ()=>{
        const src = item.getAttribute('data-src');
        audio.src = src; audio.play(); playBtn.textContent='‚è∏';
        document.querySelectorAll('.queue-item').forEach(it=>it.classList.remove('active'));
        item.classList.add('active');
      });
    });

    // Prev/Next basic wiring
    document.querySelector('.control-btn.prev').addEventListener('click', ()=>{
      const active = document.querySelector('.queue-item.active');
      if(!active) return; const idx = Number(active.getAttribute('data-idx')); const prev = document.querySelector(`.queue-item[data-idx="${idx-1}"]`); if(prev){ prev.click(); }
    });
    document.querySelector('.control-btn.next').addEventListener('click', ()=>{
      const active = document.querySelector('.queue-item.active');
      if(!active) return; const idx = Number(active.getAttribute('data-idx')); const next = document.querySelector(`.queue-item[data-idx="${idx+1}"]`); if(next){ next.click(); }
    });

  </script>

<% } else { %>
  <div class="empty-playlist">
    <p class="empty-msg">üì≠ Your playlist is empty</p>
    <p class="empty-subtitle">Add some songs to get started!</p>
    <a href="/playlists" class="back-link">‚¨Ö Back to Playlists</a>
  </div>
<% } %>
